# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Balancer Ops Frontend — a DAO operations and governance tool for the Balancer protocol. Built for the Balancer Maxis tooling suite to manage multi-chain governance operations, payload composition, injector monitoring, and contract interactions.

## Commands

```bash
yarn dev                # Start dev server (runs GraphQL codegen from .env.local, then next dev --turbo)
yarn build              # Production build (runs GraphQL codegen from .env, then next build)
yarn lint               # ESLint check
yarn lint:fix           # ESLint autofix + Prettier
yarn gen:graphql:dev    # Regenerate GraphQL types from .env.local
yarn gen:graphql:prod   # Regenerate GraphQL types from .env
```

After installing dependencies: `yarn install` runs `prisma generate` and `husky install` automatically via postinstall.

No test suite exists in this project.

## Architecture

### Framework & Stack

- **Next.js 15** with App Router (`app/` directory), Turbopack in dev
- **Chakra UI v2** with custom Balancer theme (light/dark mode)
- **TypeScript** (strict mode, path alias `@/*` → project root)
- **Yarn 1.x** as package manager

### Provider Stack (app/providers.tsx)

The app wraps all pages in nested providers in this order:
`SessionProvider` → `ApolloClientProvider` → `ThemeProvider` → `Web3Provider` (Wagmi + RainbowKit + React Query) → `CacheProvider` → `ColorThemeProvider` → `PayloadComposerProvider`

### Data Fetching Layers

- **Apollo Client** — GraphQL queries against the Balancer v3 API. Types are auto-generated by `@graphql-codegen/cli` into `lib/services/apollo/generated/`. GraphQL query files live in `lib/services/**/*.graphql`.
- **React Query** — Used for Dune Analytics queries and other REST data fetching.
- **Prisma** — PostgreSQL ORM for session management (NextAuth), injector/gauge data caching with TTL. Schema at `prisma/schema.prisma`.
- **API Routes** (`app/api/`) — Server-side endpoints for GitHub PR creation, Tenderly simulation, Dune queries, injector data, protocol fees, and more. Most have rate limiting (2 req/hour).

### Blockchain Integration

- **Wagmi v2 + Viem** for wallet interaction and chain queries
- **RainbowKit v2** for wallet connection UI
- **Ethers v6** used alongside Viem in some modules
- Supports 15+ networks: Mainnet, Arbitrum, Base, Avalanche, Gnosis, Optimism, Polygon, Polygon zkEVM, Sepolia, Mode, Fraxtal, Sonic, Hyperliquid EVM, Plasma, Monad
- Network feature support is centralized in `constants/networkFeatures.ts` — controls which networks appear in selectors per feature
- 31 ABI files in `abi/` for Balancer contracts (Vault, Gauges, Injectors, Hooks, etc.)

### Key Feature: Payload Builder

The primary feature (`app/payload-builder/`) is a multi-operation composition system:
- Users compose multiple transaction operations (fee changes, gauge enablement, payments, etc.)
- Operations persist in localStorage via `PayloadComposerContext`
- Compatibility validation between operations
- Transaction simulation via Tenderly API
- Final submission creates a GitHub PR via the Octokit API

### Authentication

NextAuth v4 with GitHub OAuth. Encrypted token storage in Prisma using AES-256-CBC (`lib/config/encrypt.ts`).

## Project Structure

```
app/                    # Next.js App Router pages and API routes
  api/                  # Server-side API endpoints
  payload-builder/      # Main payload builder (15+ sub-features)
  rewards-injector/     # Injector monitoring
  [other routes]/       # Feature-specific pages
components/             # ~80 React components (feature + shared)
lib/
  services/apollo/      # GraphQL client, queries, generated types
  services/chakra/      # Theme configuration
  modules/web3/         # Wagmi config, Web3Provider, chain definitions
  hooks/                # Custom hooks (useDuneData, usePoolBufferData, validation hooks, etc.)
  data/                 # Data fetching helpers (address book from GitHub, subgraphs, injectors)
  utils/                # Formatting, network helpers, calculations (~27 files)
  shared/               # Shared components (PaginatedTable, SearchInput) and hooks
  config/               # Encryption config
constants/              # App constants, network feature matrix
abi/                    # Solidity contract ABIs
prisma/                 # Database schema
types/                  # TypeScript type definitions
```

## Code Conventions

### Formatting & Linting

- **Prettier**: 100 char width, trailing commas, no parens on single arrow params, LF line endings
- **ESLint**: extends next/core-web-vitals + prettier. `no-console: off`, `exhaustive-deps: off`
- **Lint-staged**: Husky pre-commit runs ESLint + Prettier on staged files
- **ESLint ignored during builds** (configured in `next.config.mjs`)

### Component Patterns

- `"use client"` directive at the top of all interactive components (the root layout itself is a client component)
- **Default exports** for main page/feature components, **named exports** for smaller shared components
- Props typed as a separate interface named `ComponentNameProps`, defined directly above the component
- Local state via `useState` — no global store (Redux/Zustand). Cross-cutting state goes through Context providers
- Container components (e.g., `RewardsInjectorContainer`) manage state and pass data to presentational children
- Composition via props — no HOCs or render props

### Naming

- **Files**: PascalCase for components (`ChangeSwapFeeModule.tsx`), camelCase for utils and hooks (`formatTokenAmount.ts`, `useRewardTokenData.ts`)
- **Constants**: UPPER_SNAKE_CASE (`VAULT_ADDRESS`, `V3_VAULT_ADDRESS`)
- **Boolean state**: prefix with `is` or `show` (`isLoading`, `showManualInput`)
- **Event handlers**: prefix with `handle` (`handleNetworkChange`, `handleSelect`, `handleCopy`)

### Forms & Validation

- Forms use plain `useState` + Chakra UI inputs (`Input`, `FormControl`, `FormLabel`) — not React Hook Form
- Inline validation logic (e.g., `isAddress()` checks) with conditional rendering for error states
- Dedicated validation hooks in `lib/hooks/validation/` for complex business rules (`useValidateSwapFee`, `useValidateAmpFactor`, etc.)

### Data Fetching in Components

- **Apollo GraphQL**: `useQuery<GeneratedQueryType, GeneratedVariablesType>(GeneratedDocument, { variables, skip })` — always use the `skip` option to prevent queries when dependencies aren't ready
- **Custom hooks**: return `{ data, loading, error, refetch }` objects. Use in-memory caching with TTL and `AbortController` for cleanup (see `useRewardTokenData` as reference pattern)
- **REST calls**: plain `fetch()` to internal API routes (`/api/*`)

### API Route Patterns

- All routes use try/catch with `NextResponse.json(data)` for success and `NextResponse.json({ error: "message" }, { status: code })` for errors
- Request params via `new URL(request.url).searchParams`
- Console error logging in catch blocks

### GraphQL Workflow

- Define queries in `.graphql` files under `lib/services/apollo/`
- Run `yarn gen:graphql:dev` to regenerate types into `lib/services/apollo/generated/`
- Import generated `Document`, `Query`, and `QueryVariables` types in components
- GraphQL inline fragments for polymorphic hook params (e.g., `... on StableSurgeHookParams`)

### Display Formatting

- Token amounts: `formatTokenAmount()` from `lib/utils/formatTokenAmount.ts` — dynamic precision based on magnitude (6 decimals for < 0.01, compact notation for > 1000)
- Addresses: truncated as `0x1234...5678` (`address.slice(0, 6) + "..." + address.slice(-4)`)
- Percentages: parse the raw decimal, multiply by 100, append `%`
- Numeric precision for calculations uses `bignumber.js`
- The `porto` package is aliased to empty/false in both Turbopack and Webpack configs due to incompatible viem chain imports

### Type Organization

- Shared interfaces in `types/interfaces.ts` (e.g., `Pool`, `AddressBook`, `AddressOption`)
- Shared type aliases and unions in `types/types.ts` (e.g., `GaugeNetworkId`)
- Generated GraphQL types in `lib/services/apollo/generated/graphql.ts` — never edit manually

## Environment Variables

Required variables (see `.env` / `.env.local`):
- `NEXT_PUBLIC_BALANCER_API_URL` — Balancer v3 API endpoint (used by GraphQL codegen and Apollo)
- `NEXT_PUBLIC_DRPC_API_KEY` / `DRPC_API_KEY` — RPC provider
- `NEXT_PUBLIC_WALLET_CONNECT_ID` — WalletConnect project ID
- `DUNE_API_KEY` — Dune Analytics
- `GRAPH_API_KEY` — The Graph
- `TENDERLY_KEY` — Transaction simulation
- `AUTH_GITHUB_ID` / `AUTH_GITHUB_SECRET` — GitHub OAuth
- `ENCRYPTION_KEY` — Token encryption
- `DATABASE_URL` — PostgreSQL connection string

## Adding a New Network

1. Add the network to `NETWORK_OPTIONS` in `constants/constants.ts`
2. Add chain configuration in `lib/modules/web3/`
3. Add the network's API ID to relevant feature arrays in `constants/networkFeatures.ts`

## Adding a New Payload Builder Feature

1. Create a new route directory under `app/payload-builder/[feature-name]/`
2. Create the page component and any feature-specific modules in `components/`
3. Add navigation entry in `components/navigation/SidebarContent`
4. If needed, add ABI files in `abi/` and types in `types/`
